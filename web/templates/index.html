<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mandeye Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/vue@3.4.21/dist/vue.global.prod.js"></script>
    <style>
      pre { white-space: pre-wrap; word-break: break-word; }
    </style>
  </head>
  <body>
    <div id="app" class="container py-4">
      <h1 class="mb-4 text-center">Mandeye Status
        <span class="ms-2 badge" :class="stateBadge">{{ status.state || 'Unknown' }}</span>
      </h1>

      <div v-if="error" class="alert alert-danger" role="alert" aria-live="assertive">{{ error }}</div>
      <div v-if="message" class="alert alert-success" role="alert">{{ message }}</div>

      <div class="d-flex flex-wrap gap-2 mb-3 justify-content-center align-items-center">
        <button class="btn btn-primary" @click="sendCommand('/api/start_scan')" :disabled="loading">Start Scan</button>
        <button class="btn btn-warning" @click="sendCommand('/api/stop_scan')" :disabled="loading">Stop Scan</button>
        <button class="btn btn-danger" @click="sendCommand('/api/stopscan')" :disabled="loading">Trigger Stop Scan</button>
        <div v-if="loading" class="spinner-border spinner-border-sm text-secondary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <select v-model.number="chunkDuration" @change="updateConfig" class="form-select w-auto">
          <option :value="10">10 s</option>
          <option :value="30">30 s</option>
          <option :value="60">60 s</option>
        </select>
        <select v-model.number="chunkSize" @change="updateConfig" class="form-select w-auto">
          <option :value="50">50 MB</option>
          <option :value="100">100 MB</option>
          <option :value="200">200 MB</option>
        </select>
      </div>

      <div class="row row-cols-1 row-cols-md-3 g-3">
        <div class="col" v-for="sys in systems" :key="sys.key">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between">
              <span>{{ sys.label }}</span>
              <span :class="['badge', systemConnected(sys) ? 'bg-success' : 'bg-danger']">
                {{ systemConnected(sys) ? 'Connected' : 'Disconnected' }}
              </span>
            </div>
            <div class="card-body">
              <pre v-if="systemConnected(sys)" class="mb-0">{{ format(status[sys.key]) }}</pre>
              <div v-else :class="sys.missingClass">{{ sys.missingMsg }}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="row row-cols-1 row-cols-md-2 g-3 mt-2">
        <div class="col">
          <div class="card h-100">
            <div class="card-header">Scan Info</div>
            <div class="card-body">
              <p class="mb-1">Mode: {{ stream.mode || status.state || 'N/A' }}</p>
              <p class="mb-1">Elapsed: {{ Math.round((stream.dur||0)/1e9) }} s</p>
              <p class="mb-1">Last Saved File: {{ status.lastLazStatus && status.lastLazStatus.filename || 'N/A' }}</p>
              <p class="mb-1">Next Chunk: ~{{ (status.nextChunk && status.nextChunk.remaining_time_s || 0).toFixed(1) }} s / ~{{ (status.nextChunk && status.nextChunk.remaining_size_mb || 0).toFixed(1) }} MB</p>
              <p v-if="status.state && status.state.includes('ERROR')" class="text-danger fw-bold">Error: {{ status.state }}</p>
            </div>
          </div>
        </div>

        <div class="col">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>Logs</span>
              <div class="d-flex gap-2 align-items-center">
                <select v-model="logFilter" class="form-select form-select-sm w-auto">
                  <option value="">All</option>
                  <option value="INFO">Info</option>
                  <option value="WARN">Warn</option>
                  <option value="ERROR">Error</option>
                </select>
                <button class="btn btn-sm btn-outline-secondary" @click="clearLogs">Clear</button>
              </div>
            </div>
            <pre id="logBox" class="bg-light p-2 small mb-0" style="max-height:200px; overflow-y:auto;">
              <div v-for="(l, idx) in filteredLogs" :key="idx" :class="logClass(l.level)">{{ l.raw }}</div>
            </pre>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            status: {},
            stream: {},
            error: '',
            message: '',
            loading: false,
            logs: [],
            logFilter: '',
            systems: [
              { key:'livox', label:'Lidar', missingMsg:'Lidar not detected', missingClass:'text-danger'},
              { key:'gnss', label:'GNSS', missingMsg:'GNSS not detected', missingClass:'text-danger'},
              { key:'fs', label:'Filesystem', missingMsg:'USB storage missing', missingClass:'text-warning'}
            ],
            chunkDuration: 10,
            chunkSize: 100
          };
        },
        computed: {
          filteredLogs() {
            if (!this.logFilter) return this.logs;
            return this.logs.filter(l => l.level === this.logFilter);
          },
          stateBadge() {
            const st = this.status.state || '';
            if (st.includes('ERROR')) return 'bg-danger';
            if (st.includes('SCAN')) return 'bg-success';
            if (st) return 'bg-info';
            return 'bg-secondary';
          }
        },
        methods: {
          format(obj) {
            return JSON.stringify(obj || {}, null, 2);
          },
          systemConnected(sys) {
            const data = this.status[sys.key];
            if (!data) return false;
            if (sys.key === 'livox') {
              if (!data.init_success) return false;
              const ts = data?.LivoxLidarInfo?.timestamp_s;
              if (!ts) return false;
              return (Date.now() / 1000 - ts) < 5;
            }
            if ('init_success' in data) return !!data.init_success;
            return Object.keys(data).length > 0;
          },
          updateStatus() {
            fetch('/api/status')
              .then(r => r.json())
              .then(data => { this.status = data; this.chunkDuration = data.chunk?.duration_s || this.chunkDuration; this.chunkSize = data.chunk?.size_mb || this.chunkSize; })
              .catch(err => {
                this.error = `Failed to fetch status: ${err.message}`;
                setTimeout(() => this.error = '', 3000);
              });
          },
          sendCommand(url) {
            this.loading = true;
            fetch(url, { method: 'POST' })
              .then(r => {
                if (!r.ok) throw new Error('Command failed');
                this.message = 'Command successful';
                setTimeout(() => this.message = '', 3000);
              })
              .catch(err => {
                this.error = err.message;
                setTimeout(() => this.error = '', 3000);
              })
              .finally(() => {
                this.loading = false;
              });
          },
          logClass(level) {
            return {
              ERROR: 'text-danger',
              WARN: 'text-warning',
              INFO: 'text-info'
            }[level] || 'text-body';
          },
          clearLogs() {
            this.logs = [];
          },
          updateConfig() {
            fetch('/api/config', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ chunk_size_mb: this.chunkSize, chunk_duration_s: this.chunkDuration })
            });
          }
        },
        mounted() {
          this.updateStatus();
          setInterval(this.updateStatus, 5000);

          const source = new EventSource('/api/stream');
          source.onmessage = e => {
            try { this.stream = JSON.parse(e.data); } catch (err) {}
          };
          source.onerror = () => {
            this.error = 'Stream connection lost';
            setTimeout(() => this.error = '', 3000);
          };

          const logSource = new EventSource('/api/logs');
          logSource.onmessage = e => {
            const raw = e.data;
            const m = raw.match(/^\[(\w+)\]\s*(.*)$/);
            const level = m ? m[1] : 'INFO';
            const message = m ? m[2] : raw;
            this.logs.push({level, message, raw});
            if (this.logs.length > 200) this.logs.shift();
            this.$nextTick(() => {
              const box = document.getElementById('logBox');
              box.scrollTop = box.scrollHeight;
            });
          };
          logSource.onerror = () => {
            this.error = 'Log stream connection lost';
            setTimeout(() => this.error = '', 3000);
          };
        }
      }).mount('#app');
    </script>
  </body>
</html>
